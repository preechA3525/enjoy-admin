<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/preechA3525/enjoy-admin/main/enjoy.png">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/preechA3525/enjoy-admin/main/enjoy.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Enjoy Admin">

    <title>Enjoy Cafe - Admin System</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #2e7d32; --accent: #ef6c00; --danger: #c62828; --bg: #f4f7f6; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; padding-top: env(safe-area-inset-top); }
        
        /* ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Login */
        #loginOverlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: #1a1a1a; 
            z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .pin-input { font-size: 32px; letter-spacing: 15px; text-align: center; width: 220px; padding: 12px; border-radius: 12px; border: none; margin-top: 20px; color: #333; }

        .container { max-width: 600px; margin: auto; display: none; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        h2 { font-size: 1.1rem; color: var(--primary); margin: 0; }
        
        .search-group { display: flex; gap: 8px; margin-bottom: 10px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; background: white; -webkit-appearance: none; }
        
        button { border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; -webkit-appearance: none; }
        .btn-search { background: var(--primary); color: white; min-width: 80px; }
        .btn-logout { background: #555; color: white; padding: 6px 12px; font-size: 12px; }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å/‡∏•‡∏ö‡πÅ‡∏ï‡πâ‡∏° */
        .points-action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .btn-add { background: var(--primary); color: white; padding: 15px; font-size: 16px; }
        .btn-minus { background: var(--danger); color: white; padding: 15px; font-size: 16px; }

        .total-badge { background: #e8f5e9; color: var(--primary); padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; margin-bottom: 10px; display: inline-block; }
        #resultArea { display: none; background: #e8f5e9; border: 1px solid #c8e6c9; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .points-val { font-size: 42px; font-weight: bold; color: var(--danger); text-align: center; margin: 5px 0; }
        
        .table-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8f9fa; padding: 12px 10px; text-align: left; color: #666; border-bottom: 2px solid #eee; }
        td { padding: 14px 10px; border-bottom: 1px solid #f0f0f0; }
        
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .btn-page { flex: 1; background: #546e7a; color: white; margin: 0 5px; padding: 12px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 90%; max-width: 400px; border-radius: 15px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div style="font-size: 22px; font-weight: bold; letter-spacing: 1px;">‚òï Enjoy Cafe Admin</div>
    <div style="margin-top: 15px; color: #ccc; font-size: 14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å</div>
    <input type="password" id="pinField" class="pin-input" maxlength="4" inputmode="numeric" autocomplete="off">
    <button onclick="checkPIN()" style="margin-top: 20px; width: 220px; background: #2e7d32; color: white; border-radius: 12px; font-size: 18px; height: 50px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
</div>

<div class="container" id="mainApp">
    <div class="card">
        <div class="header-flex">
            <h2>üõ† ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
            <button class="btn-logout" onclick="logout()">üîí ‡∏≠‡∏≠‡∏Å</button>
        </div>
        <div class="search-group">
            <input type="text" id="phoneInput" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤..." inputmode="tel">
            <button class="btn-search" onclick="searchCustomer()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
        </div>

        <div id="resultArea">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="idDisplay">-</b>
                <button onclick="showHistory()" style="background:#0277bd; color:white; padding:6px 12px; font-size:12px; border-radius:6px;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="points-val" id="pointsDisplay">0</div>
            <div style="background:white; padding:12px; border-radius:10px;">
                <input type="number" id="adjustAmount" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°..." inputmode="numeric">
                <div class="points-action-group">
                    <button class="btn-add" onclick="updatePoints('plus')">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°</button>
                    <button class="btn-minus" onclick="updatePoints('minus')">‚ûñ ‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div id="totalMembers" class="total-badge">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: 0 ‡∏£‡∏≤‡∏¢</div>
        <button onclick="exportToExcel()" style="background:#388e3c; color:white; width:100%; margin-bottom:12px; border-radius:8px; padding:12px;">üì• ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel</button>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px;">
            <select id="sortBy" onchange="applySortAndRender()"><option value="lastUpdated">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option><option value="points">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ï‡πâ‡∏°</option></select>
            <select id="sortOrder" onchange="applySortAndRender()"><option value="desc">‡∏°‡∏≤‡∏Å‚ûî‡∏ô‡πâ‡∏≠‡∏¢</option><option value="asc">‡∏ô‡πâ‡∏≠‡∏¢‚ûî‡∏°‡∏≤‡∏Å</option></select>
        </div>

        <div class="table-container">
            <table>
                <thead><tr><th style="width:40px;">#</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>‡πÅ‡∏ï‡πâ‡∏°</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="pagination">
            <button id="prevBtn" class="btn-page" onclick="changePage(-1)">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
            <span id="pageDisplay" style="font-weight:bold;">1/1</span>
            <button id="nextBtn" class="btn-page" onclick="changePage(1)">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
    </div>
</div>

<div id="historyModal" class="modal"><div class="modal-content"><h3 style="margin-top:0;">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3><div id="historyList" style="max-height:300px; overflow-y:auto;"></div><button onclick="closeModal()" style="width:100%; margin-top:20px; background:#f0f0f0; border-radius:8px; padding:10px;">‡∏õ‡∏¥‡∏î</button></div></div>

<script>
    const ADMIN_PIN = "3525"; 

    const firebaseConfig = {
        apiKey: "AIzaSyDA0IgzG0JBN6b8ZTgGiyjP75-Udhrby7A",
        authDomain: "point-system-dc140.firebaseapp.com",
        databaseURL: "https://point-system-dc140-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "point-system-dc140",
        storageBucket: "point-system-dc140.firebasestorage.app",
        messagingSenderId: "419594986748",
        appId: "1:419594986748:web:7f792375cde20b55736379",
        measurementId: "G-RPXCCLLYPF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    let selectedId = null, currentPage = 1, pageSize = 50, cachedData = [];

    function checkPIN() {
        const pin = document.getElementById('pinField').value;
        if(pin === ADMIN_PIN) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadData();
        } else {
            alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            document.getElementById('pinField').value = "";
        }
    }

    function logout() {
        document.getElementById('pinField').value = "";
        document.getElementById('loginOverlay').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
    }

    function searchCustomer() {
        const id = document.getElementById('phoneInput').value.trim();
        if(!id) return;
        db.ref('customers/' + id).once('value', snapshot => {
            if(snapshot.exists()) {
                selectedId = id;
                document.getElementById('idDisplay').innerText = "‡πÄ‡∏ö‡∏≠‡∏£‡πå: " + id;
                document.getElementById('pointsDisplay').innerText = (snapshot.val().points || 0).toLocaleString();
                document.getElementById('resultArea').style.display = 'block';
            } else { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏ô‡∏µ‡πâ"); }
        });
    }

    function updatePoints(type) {
        let val = parseInt(document.getElementById('adjustAmount').value);
        if(isNaN(val) || val <= 0) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏ï‡πâ‡∏°");
        if(type === 'minus') val = val * -1;

        const now = Date.now();
        db.ref('customers/' + selectedId).transaction(c => {
            if(c) { 
                c.points = (c.points || 0) + val; 
                c.lastUpdated = now; 
            }
            return c;
        }, (err) => {
            if(!err) {
                db.ref('point_history/' + selectedId).push({ amount: val, timestamp: now });
                alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                document.getElementById('adjustAmount').value = "";
                searchCustomer();
                loadData(); 
            }
        });
    }

    function loadData() {
        db.ref('customers').once('value', snapshot => {
            if(!snapshot.exists()) return;
            const data = snapshot.val();
            cachedData = Object.keys(data).map(k => ({
                id: k, 
                points: data[k].points || 0, 
                lastUpdated: data[k].lastUpdated || 0 
            }));
            document.getElementById('totalMembers').innerText = `‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${cachedData.length.toLocaleString()} ‡∏£‡∏≤‡∏¢`;
            applySortAndRender();
        });
    }

    function applySortAndRender() {
        const sortBy = document.getElementById('sortBy').value;
        const order = document.getElementById('sortOrder').value;

        cachedData.sort((a, b) => {
            let vA = a[sortBy];
            let vB = b[sortBy];
            return order === 'desc' ? vB - vA : vA - vB;
        });
        
        currentPage = 1; 
        renderTable();
    }

    function renderTable() {
        const start = (currentPage - 1) * pageSize;
        const pageItems = cachedData.slice(start, start + pageSize);
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = "";
        pageItems.forEach((item, index) => {
            tbody.innerHTML += `<tr><td>${start+index+1}</td><td><b>${item.id}</b></td><td style="color:var(--primary); font-weight:bold;">${item.points.toLocaleString()}</td></tr>`;
        });
        document.getElementById('pageDisplay').innerText = `${currentPage} / ${Math.ceil(cachedData.length/pageSize)}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage * pageSize >= cachedData.length;
    }

    function changePage(s) { currentPage += s; renderTable(); }

    function showHistory() {
        document.getElementById('historyModal').style.display = 'block';
        const list = document.getElementById('historyList');
        list.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
        db.ref('point_history/' + selectedId).limitToLast(10).once('value', s => {
            list.innerHTML = "";
            s.forEach(c => {
                const log = c.val();
                const d = new Date(log.timestamp).toLocaleDateString('th-TH');
                const t = new Date(log.timestamp).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                list.innerHTML = `<div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
                    <span>${d} ${t}</span><b style="color:${log.amount>=0?'green':'red'}">${log.amount>=0?'+':''}${log.amount}</b>
                </div>` + list.innerHTML;
            });
        });
    }

    function exportToExcel() {
        const rows = cachedData.map((d, i) => ({ "‡∏•‡∏≥‡∏î‡∏±‡∏ö": i+1, "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£": d.id, "‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠": d.points }));
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Members");
        XLSX.writeFile(wb, "EnjoyCafe_Data.xlsx");
    }

    function closeModal() { document.getElementById('historyModal').style.display = 'none'; }
</script>
</body>
</html>

